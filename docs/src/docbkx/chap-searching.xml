<?xml version="1.0" encoding="utf-8"?>

<chapter xmlns="http://docbook.org/ns/docbook"
         xmlns:xlink="http://www.w3.org/1999/xlink">

  <title>Searching</title>  

  <para>Once the indexing process is started and some data has been
  indexed, you can start to perform searches against the Sensei cluster.
  A search query is done by building a Sensei request and sending it to
  a Sensei broker.  You can do this using a native Java Sensei client,
  or other client APIs that support other languages like Python or
  JavaScript.</para>

  <para>Upon receiving a request, a Sensei broker passes it to a set of
  selected Sensei nodes, merges the search results from these nodes, and
  then returns the merged results back to the requester.  What set of
  Sensei nodes are selected for a request is decided using load
  balancer.  Based on the need of the applications, you can plug in
  different customized load balancers.  By default, Sensei uses a load
  balancer that distributes work load based on consistent
  hashing.</para>

  <section>
    <title>Sensei Request</title>

    <para>A Sensei request contains the following main
    parameters:</para>

    <itemizedlist>
      <listitem>
        <para>Query: the input query string</para>
      </listitem>
      <listitem>
        <para>Offset: the starting offset of search results</para>
      </listitem>
      <listitem>
        <para>Count: the number of search results to return</para>
      </listitem>
      <listitem>
        <para>Initializing parameters for runtime facet handlers: a map
        that contains the initializing parameters that are needed by all
        runtime facet handlers</para>
      </listitem>
      <listitem>
        <para>Flag indicating whether stored fields are to be
        fetched</para>
      </listitem>
      <listitem>
        <para>Partitions: shards of the index to be searched</para>
      </listitem>
      <listitem>
        <para>Flag indicating whether explanation information should be returned</para>
      </listitem>
      <listitem>
        <para>Routing parameter: the field value used for routing</para>
      </listitem>
      <listitem>
        <para>Group-by field: the field name used for the group-by
        operation (also called <emphasis>field collapsing <indexterm> 
        <primary>field collapsing</primary>
        </indexterm></emphasis>)</para>
      </listitem>
    </itemizedlist>

  </section>

  <section>
    <title>Load Balancing</title>

    <para>(To be finished)</para>
  </section>

  <section>
    <title>RESTful API</title>

    <section>
      <title>Scalar Parameters</title>

      <itemizedlist>
        <listitem>
          <para><emphasis role="bold">Query parameter:</emphasis>
          <literal>q</literal></para>

          <para>The <literal>q</literal> parameter specifies the query string.</para>
        </listitem>

        <listitem>
          <para><emphasis role="bold">Fetch stored fields:</emphasis>
          <literal>fetchstored</literal></para>

          <para>This is a boolean parameter that specifies whether
          stored fields should be fetched or not.</para>
        </listitem>

        <listitem>
          <para><emphasis role="bold">Show explanation:</emphasis>
          <literal>showexplain</literal></para>

          <para>This is a boolean parameter that specifies whether query
          explanation information should be returned in the search
          result.</para>
        </listitem>

        <listitem>
          <para><emphasis role="bold">Starting offset:</emphasis>
          <literal>start</literal></para>

          <para>This is the offset value used for search result
          pagination.</para>
        </listitem>

        <listitem>
          <para><emphasis role="bold">Number of result:</emphasis>
          <literal>rows</literal></para>

          <para>This parameter specifies how many results should be
          returned for this query.</para>
        </listitem>

        <listitem>
          <para><emphasis role="bold">Routing parameter:</emphasis>
          <literal>routeparam</literal></para>

          <para>This parameter specifies the value of the field used for
          routing (i.e. load balancing).</para>
        </listitem>

        <listitem>
          <para><emphasis role="bold">Group-by parameter:</emphasis>
          <literal>groupby</literal></para>

          <para>This parameter specifies the field name used to do the
          group-by operation.</para>
        </listitem>

      </itemizedlist>

      <example>
        <title>Scalar Parameters</title>
        <programlisting><![CDATA[  q=ipad 2&fetchstored=true&showexplain=false&start=0&rows=10
  q=linkedin&start=0&rows=10&routeparam=12345&groupby=userid
]]></programlisting>
      </example>

    </section>

    <section>
      <title>Sort Fields Parameter</title>

      <itemizedlist>

        <listitem>
          <para><emphasis role="bold">Sort fields parameter:</emphasis>
          <literal>sort</literal></para>

          <para>This parameter specifies how the search results should
          be sorted.  The results can be sorted based on one or multiple
          fields, in either ascending or descending order.  The value of
          this parameter consists of a list of comma separated strings,
          each of which can be one of the following values:</para>

          <itemizedlist>
            <listitem>
              <para><literal>relevance</literal>: this means that the
              results should be sorted by scores in descending
              order.</para>
            </listitem>
            <listitem>
              <para><literal>relrev</literal>: this means that the
              results should be sorted by scores in ascending
              order.</para>
            </listitem>
            <listitem>
              <para><literal>doc</literal>: this means that the results
              should be sorted by doc ids in ascending order.</para>
            </listitem>
            <listitem>
              <para><literal>docrev</literal>: this means that the
              results should be sorted by doc ids in descending
              order.</para>
            </listitem>
            <listitem>
              <para><literal>&lt;field-name&gt;:&lt;direction&gt;</literal>:
              this means that the results should be sorted by field
              <literal>&lt;field-name&gt;</literal> in the direction of
              <literal>&lt;direction&gt;</literal>, which can be either
              <literal>asc</literal> or <literal>desc</literal>.</para>
            </listitem>
          </itemizedlist>
        </listitem>
      </itemizedlist>

      <example>
        <title>Sort Fields Parameters</title>
        <programlisting><![CDATA[  sort=relevance
  sort=docrev
  sort=price:desc,color=asc
]]></programlisting>
      </example>

    </section>

    <section>
      <title>Query Parameters</title>

      <itemizedlist>
        <listitem>
          <para><emphasis role="bold">Query Parameters:</emphasis>
          <literal>qparam</literal></para>

          <para>This parameter specifies a list of arbitrary query
          parameters in the form of name-value pairs, separated by
          commas.  Each pair is formatted as
          <literal>&lt;name&gt;:&lt;value&gt;</literal>.</para>

          <para>This parameter is commonly used to pass query-level
          parameters to dynamic runtime facet handlers.</para>
        </listitem>
      </itemizedlist>

      <example>
        <title>Query Parameters</title>
        <programlisting><![CDATA[  qparam=arg1:123,arg2:abc
]]></programlisting>
      </example>
      

    </section>

    <section>
      <title>Selection Parameters</title>

      <itemizedlist>
        <listitem>
          <para><emphasis role="bold">Not-value parameter:</emphasis>
          <literal>select.&lt;field-name&gt;.no</literal></para>

          <para>This parameter specifies what values for a field should be excluded
          from the search results.</para>
        </listitem>
        <listitem>
          <para><emphasis role="bold">Value parameter:</emphasis>
          <literal>select.&lt;field-name&gt;.val</literal></para>

          <para>This parameter specifies what values for a field should
          be included in the search results.</para>
        </listitem>
        <listitem>
          <para><emphasis role="bold">Operator parameter:</emphasis>
          <literal>select.&lt;field-name&gt;.op</literal></para>

          <para>This parameter specifies the operator used for selection
          values: <literal>and</literal> or
          <literal>or</literal>.</para>
        </listitem>

        <listitem>
          <para><emphasis role="bold">Property parameter:</emphasis>
          <literal>select.&lt;field-name&gt;.prop</literal></para>

          <para>This parameter specifies the additional properties if a
          selection is on a field with the <emphasis>path</emphasis>
          type.</para>
        </listitem>

      </itemizedlist>

      <example>
        <title>Selection Parameters</title>
        <programlisting><![CDATA[  select.color.val=red,yellow&select.color.op=or&start=0&select.color.not=black
]]></programlisting>
      </example>

    </section>

    <section>
      <title>Facet Specification Parameters</title>

      <itemizedlist>
        <listitem>
          <para><emphasis role="bold">Maximum count parameter:</emphasis>
          <literal>facet.&lt;facet-name&gt;.max</literal>
          </para>

          <para>This parameter specifies the maximum count value for a
          facet with name <literal>fact-name</literal>.</para>
        </listitem>
        <listitem>
          <para><emphasis role="bold">Order-by parameter:</emphasis>
          <literal>facet.&lt;facet-name&gt;.order</literal>
          </para>

          <para>This parameter specifies how facet values should be
          ordered:</para>

          <itemizedlist>
            <listitem>
              <para><literal>hits</literal>: order-by hits</para>
            </listitem>
            <listitem>
              <para><literal>val</literal>: order-by values</para>
            </listitem>
          </itemizedlist>
        </listitem>
        <listitem>
          <para><emphasis role="bold">Selection-expand parameter:</emphasis>
          <literal>facet.&lt;facet-name&gt;.expand</literal>
          </para>

          <para></para>
        </listitem>
        <listitem>
          <para><emphasis role="bold">Minimum hits parameter:</emphasis>
          <literal>facet.&lt;facet-name&gt;.minhit</literal>
          </para>

          <para></para>
        </listitem>
      </itemizedlist>

      <example>
        <title>Facet Specification Parameters</title>
        <programlisting><![CDATA[  facet.color.minhit=1&facet.color.max=3&facet.color.order=val&facet.color.expand=True
]]></programlisting>
      </example>

    </section>

  </section>

</chapter>
